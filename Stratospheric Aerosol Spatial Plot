import earthaccess
import xarray as xr
from xarray.backends.api import open_datatree
import matplotlib.pyplot as plt
import cartopy.crs as ccrs
import cartopy.feature as cfeature
import numpy as np
from matplotlib.colors import LogNorm
import cmocean
import pandas as pd
import matplotlib.colors as mcolors
import os

auth = earthaccess.login(persist=True)

tspan = ("2015-01-30", "2016-12-30")
results = earthaccess.search_data(short_name="OMPS_NPP_LP_L3_AER_MONTHLY", temporal=tspan,)
paths = earthaccess.open(results)

dataset = xr.open_dataset(paths[4])

strat_var = "StratColumn"

plt.figure(figsize=(10, 6))
plt.hist(dataset[strat_var].values.flatten(), range=[0, 0.25], bins=30)
plt.title("Histogram of Stratospheric Aerosol Values")
plt.show()


#  Save plots to a directory
save_directory = "Plots/Spatial Stratospheric Aerosols"
os.makedirs(save_directory, exist_ok=True)


#  Create the spatial stratospheric aerosol plot for a specific month
fig, ax = plt.subplots(figsize=(12, 7), subplot_kw={'projection': ccrs.PlateCarree()})

data = dataset[strat_var]

if 'Wavelength' in data.dims:
    wavelengths = dataset.Wavelength.values
    target_wavelength = 675
    closest_idx = np.argmin(np.abs(wavelengths - target_wavelength))
    actual_wavelength = wavelengths[closest_idx]
    
    data = data.isel(Wavelength=closest_idx)
    wavelength_label = f" at {actual_wavelength} nm"
else:
    wavelength_label = ""

lat = dataset['Latitude'].values
lon = dataset['Longitude'].values

colors = ['yellow', 'orange', 'red', 'darkred']
n_bins = 256
cmap_custom = mcolors.LinearSegmentedColormap.from_list('yellow_red', colors, N=n_bins)

im = ax.imshow(data.values.T, 
               extent=[lon.min(), lon.max(), lat.min(), lat.max()],
               transform=ccrs.PlateCarree(),
               cmap='YlOrRd',
               vmin=0, vmax=0.04, 
               origin='lower')

ax.coastlines()
ax.add_feature(cfeature.BORDERS)
gl = ax.gridlines(draw_labels=True, alpha=0.5)
gl.xlabel_style = {'size': 16}  # Longitude label size
gl.ylabel_style = {'size': 16}
ax.set_extent([lon.min(), lon.max(), lat.min(), lat.max()], crs=ccrs.PlateCarree())

cbar = plt.colorbar(im, ax=ax, shrink=0.6, pad=0.15)
cbar.set_label(f'Stratospheric Aerosol Level', fontsize=20)
cbar.ax.tick_params(labelsize=16)

plt.title(f"OMPS Stratospheric Aerosol at 675 nm - May 2015", fontsize=28)

save_path = os.path.join(save_directory, 'May2015_SpatialAerosols.png')
plt.savefig(save_path, dpi=300, bbox_inches='tight')
plt.show()


#  Create the difference between two months
march_dataset = xr.open_dataset(paths[3]) 
april_dataset = xr.open_dataset(paths[4])  

march_data = march_dataset["StratColumn"]
april_data = april_dataset["StratColumn"]

if 'Wavelength' in march_data.dims:
    wavelengths = march_dataset.Wavelength.values
    target_wavelength = 675
    closest_idx = np.argmin(np.abs(wavelengths - target_wavelength))
    
    march_data = march_data.isel(Wavelength=closest_idx)
    april_data = april_data.isel(Wavelength=closest_idx)

difference = april_data - march_data

fig, ax = plt.subplots(figsize=(12, 7), subplot_kw={'projection': ccrs.PlateCarree()})

lat = march_dataset['Latitude'].values
lon = march_dataset['Longitude'].values

# Plot the difference using a diverging colormap (good for showing positive/negative changes)
im = ax.imshow(difference.values.T, 
               extent=[lon.min(), lon.max(), lat.min(), lat.max()],
               transform=ccrs.PlateCarree(),
               cmap='YlOrRd',
               vmin=-0.01, vmax=0.01,  # Adjust range based on your difference values
               origin='lower')

# Add map features
ax.coastlines()
ax.add_feature(cfeature.BORDERS)
ax.gridlines(draw_labels=True, alpha=0.5)
ax.set_extent([lon.min(), lon.max(), lat.min(), lat.max()], crs=ccrs.PlateCarree())

# Add colorbar
cbar = plt.colorbar(im, ax=ax, shrink=0.6, pad=0.05)
cbar.set_label('Stratospheric Aerosol Difference')

plt.title('Stratospheric Aerosol Difference: April 2023 - March 2023 at 675nm')
plt.show()
